# Настройка сети в Linux. Работа с IPtables
**ip r** - просмотр информации о соединении с маршрутизатором

![ip_r](/img/ip_r.png "Команда ip r")

**ss -tu** - просмотр текущих активных соединений по протоколам TCP IP

![ss_ut](/img/ss_ut.png "Команда ss -ut")

**ss -tulpan** - просмотр информации о всех соединениях (ключ a) по протоколам TCP (ключ t) и UDP (ключ u) с указание процесса, использующего указанное соединение (ключ p, требуются права админа). Порты соединений показываются в числовом варианте (ключ n). Ключ l в данном случае можно опустить, так как данный ключ указывает, что необходимо выводить только информацию о прослушиваемых портах. Ключ a его перекрывает

![ss_tulpan](/img/ss_tulpan.png "Команда ss -tulpan")

**top** - просмотр информации о процессах

![top](/img/top.png "Команда top")

**htop** - просмотр и управление процессами

![htop](/img/htop.png "Команда htop")

Физически сетевые интерфейсы располагаются в каталоге /sys/class/net/

![net_interface](/img/net_interface.png "Расположение сетевых интерфейсов")

Текущая сетевая конфигурация лежит в файле /cat/netplan/01-network-manager-all.yaml
Формат yaml - аналог JSON, только за вложенность объектов отвечают отступы (похож на python)

Применим следующую конфигурацию и разберём, что применили

![net_conf](/img/net_conf.png "Конфигурация сети")

**renderer** - текущая служба для управления сетевыми интерфейсами

**Ethernets** - обращение к сетевым интерфесам

**enp0s3** - обращение к сетвому интерфейсу enp0s3 (в данный момент, основному интерфейсу)

**dhcp4** - служба DHCP. Значение no - отключает, значение Yes - включает

**addresses** - указываются адреса в виде списка, которые необходимо присвоить сетевому интерфейсу

**nameservers** - DNS адреса

После записи конфигурации в файл, необходимо выполнить команду **netplan try**, которая применит настройки для тестирования на 120 сек. В случае, если соединение пропало - изменения откатятся автоматически к прежним корректным. Если новые настройки корректны, но по нажатию Enter настройки применятся

**ping -c 4 gb.ru** - пинг с указанием кол-ва попыток

**host gb.ru** - позволяет узнать IP адрес по DNS имени

**tracepath gb.ru** - трассировка маршрута пакетов до указанного узла

## Работа с IPTables
---

**iptables** - аналог брандмауэра

**iptables -L** - просмотрсписка правил

**iptables -P INPUT DROP** - запрет всех входящих соединений

**iptables -A INPUT -p tcp --dport 22 -j ACCEPT** - разрешение входящих подключений по 22 порту TCP

**iptables -t nat -A PREROUTING -p tcp --dport 2222 -j REDIRECT --to-port 22** - перенаправление подключения по порту 2222 TCP на порт 22 TCP

При настройке правил нужно учитывать, что при перезагрузке системы все ранее настроенные правила сбросятся. Чтобы их сохранить, необходимо выполнить команду **iptables-save > iptables_config**, чтобы сохранить конфигурацию в файл.

Чтобы импортировать конфигурацию из файла, необходимо **iptables-restore < iptables_config**